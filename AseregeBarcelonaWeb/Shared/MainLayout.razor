@inherits LayoutComponentBase
<MudThemeProvider/>
<MudDialogProvider/>
<MudSnackbarProvider/>

<MudLayout>
    <MudAppBar style="background-color:black;" Elevation="1">
        <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" OnClick="@((e) => DrawerToggle())" />
        <MudSpacer />

        
        <MudChipSet @bind-SelectedChip="selected" SelectedValuesChanged="SelectedValuesChanged" Filter="true" Mandatory="true">
            <MudChip Text="blue" Color="Color.Info">Home</MudChip>

            @if (currentUser != null)
            {
                @if (currentUser.Roles_idroles == 1 || currentUser.Roles_idroles == 2)
                {
                    <MudChip Text="pink" Color="Color.Secondary">Transportes</MudChip>
                    <MudChip Text="red" Color="Color.Error">Visitas</MudChip>
                }             
            }
            
            <MudChip Text="orange" Color="Color.Warning">Quienes somos</MudChip>            
        </MudChipSet>

                   
       
       
        <MudMenu>
            <ActivatorContent>
                <Multiavatar Width="48px" Height="48px" AvatarId="@MultiAvatarUserName" />                
            </ActivatorContent>
            <ChildContent>                                                               
                @if (loginState)
                {                    
                    <MudMenuItem OnClick="@(async(e) => await ShowProfile())" Icon="@Icons.Material.Filled.Edit">Perfil</MudMenuItem>
                    <MudMenuItem OnClick="@(async(e) => await CloseSession())" Icon="@Icons.Material.Filled.Logout">Cerrar Sesión</MudMenuItem>
                    
                }
                else
                {
                    <MudMenuItem OnClick="@(async(e) => await RegisterAsync())" Icon="@Icons.Material.Filled.Login">Registrarse</MudMenuItem>
                    <MudMenuItem OnClick="@(async(e) => await AuthorizeAsync())" Icon="@Icons.Material.Filled.Login">Iniciar Sesión</MudMenuItem>
                }

                
            </ChildContent>
        </MudMenu>

    </MudAppBar>
    <MudDrawer @bind-Open="ChangeSidebar" Elevation="2">
        <MudDrawerHeader>
            <MudText Typo="Typo.h5" Class="mt-1">Aserege Framework</MudText>
        </MudDrawerHeader>                
      
        <MudPaper Width="250px" Class="d-inline-flex py-3" Elevation="0">
            <MudNavMenu Class="mud-width-full">
                <MudText Typo="Typo.h6" Class="px-4">Barcelona Web</MudText>
                <MudDivider Class="my-2" />
                <MudNavLink OnClick="@(async(e) => await TravelTo("api"))" Icon="@Icons.Material.Filled.Dashboard">Peticiones JSON</MudNavLink>                            
                <MudNavGroup Title="Settings" Icon="@Icons.Material.Filled.Settings" Expanded="true">
                    <MudNavLink OnClick="@(async(e) => await TravelTo("admin"))" Icon="@Icons.Material.Filled.People" IconColor="Color.Success">Panel de Administracion</MudNavLink>                    
                </MudNavGroup>
            </MudNavMenu>
        </MudPaper>

    </MudDrawer>
    <MudMainContent Class="px-4">     
        @switch (SelectedPage)
        {
        case "blue":               
            <MainPage></MainPage>        
            break;
        case "register":
            <Register></Register>
            break;
        case "login":
                <MudPaper Class="pa-16 ma-2" Square="false" Elevation="3">
                    <MudTextField @bind-Value="Name" Label="Nombre de usuario" Variant="Variant.Text" />

                    <MudTextField @bind-Value="Password" Class="mt-2"
                          Label="Contraseña"
                          Variant="Variant.Text"
                          InputType="@PasswordInput"
                          Adornment="Adornment.End"
                          AdornmentIcon="@PasswordInputIcon"
                          OnAdornmentClick="ButtonTestclick" AdornmentAriaLabel="Show Password" />

                    <MudButton Class="mt-4" Variant="Variant.Filled" Color="Color.Primary" FullWidth="true" OnClick="async(e) => await LoginAsync()">Iniciar Sesión</MudButton>
                </MudPaper>
            break;
        case "pink":                 
            <Transportes></Transportes>
            break;
        case "red":
            <Visitas></Visitas>
            break;
        case "orange":
            <div>QUIENES SOMOS</div>
            break;
        case "profile":
            <VerPerfil></VerPerfil>
            break;
        case "admin":                
            <PanelAdministracion></PanelAdministracion>
            break;
        case "api":
            <Api></Api>
            break;
        default:                
            <MudProgressLinear Color="Color.Error" Indeterminate="true" Class="my-7" />
            <MudText style="font-family: 'Quattrocento', serif;" Align="Align.Center" Typo="Typo.h4"></MudText>                              
            break;
        }
        
        <Footer></Footer>                
    </MudMainContent>
    
</MudLayout>
@code
{
    /// <summary>
    /// /ROUTER REAL PAGE
    /// </summary>

    private User currentUser = new User();
    private MudChip selected;    
    bool ChangeSidebar = true;

    public string SelectedPage { get; set; } = "Blue";
    private string MultiAvatarUserName { get; set; } = "NADIE";

    bool loginState { get; set; } = false;
    private async Task<bool> GetLoginSessionState()
    {        
        return await jsRuntime.InvokeAsync<string>("localStorage.getItem", "Name") != null || await jsRuntime.InvokeAsync<string>("localStorage.getItem", "Password") != null;        
    }
    void DrawerToggle() => ChangeSidebar = !ChangeSidebar;

    private void SelectedValuesChanged()
    {
        SelectedPage = selected.Text;
        StateHasChanged();
    }

    private async Task TravelTo(string page)
    {
        SelectedPage = page;
        await Task.CompletedTask;        
    }    
    private async Task AuthorizeAsync()
    {
        using (Manager.MySQLManager manager = new Manager.MySQLManager())
        {
            string Name = await jsRuntime.InvokeAsync<string>("localStorage.getItem", "Name");
            string Password = await jsRuntime.InvokeAsync<string>("localStorage.getItem", "Password");
            if (Name == null | Password == null)
            {                
                currentUser.Nombre = "";
                currentUser.Passwordseguro = "";                
                await TravelTo("login");  

                StateHasChanged();               
            }
            else
            {
                currentUser = manager.GetUser(new Authorize() { Name = Name, Password = Password });
            }

        }
        await Task.CompletedTask;
    }

    private async Task ShowProfile()
    {
        await TravelTo("profile");        
        await Task.CompletedTask;
    }
    private async Task CloseSession()
    {
        string nombre = await jsRuntime.InvokeAsync<string>("localStorage.removeItem", "Name");
        string Password = await jsRuntime.InvokeAsync<string>("localStorage.removeItem", "Password");
        StateHasChanged();
    }      
    protected override async Task OnInitializedAsync()
    {        
        await TravelTo("blue");
    }
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        loginState = await GetLoginSessionState();
        
        if (!loginState)
        {
            if (currentUser.Nombre == null)
            {
                currentUser.Nombre = "NADIE";            
                await jsRuntime.InvokeVoidAsync("localStorage.setItem", "Name", currentUser.Nombre);            
            }
            currentUser.Nombre = await jsRuntime.InvokeAsync<string>("localStorage.getItem", "Name");
            MultiAvatarUserName = currentUser.Nombre;
        }                
        await Task.CompletedTask;
    }


    private async Task RegisterAsync()
    {
        await TravelTo("register");
        await Task.CompletedTask;
    }


    /// <summary>
    /// /LOGIN CODE
    /// </summary>

    public string Name { get; set; } = "";
    public string Password { get; set; } = "";

    bool isShow = false;

    InputType PasswordInput = InputType.Password;
    string PasswordInputIcon = Icons.Material.Filled.VisibilityOff;

    void ButtonTestclick()
    {
        isShow = !isShow;
        switch (isShow)
        {
            case false:
                PasswordInputIcon = Icons.Material.Filled.Visibility;
                PasswordInput = InputType.Text;
                break;
            case true:
                PasswordInputIcon = Icons.Material.Filled.VisibilityOff;
                PasswordInput = InputType.Password;
                break;
        }
    }
    //Esta funcion se encarga de validar el usuario logeado (comprovar si existe en la base de datos) de manera asincrona
    private async Task LoginAsync()
    {

        Manager.MySQLManager manager = new MySQLManager();
        
        //este authorize permite autenticar el usuario 
        //En el apartado del Password, genera el hash de la contraseña intruducida y comprueba si su valor corresponde a la de la base de datos
        //Si el usuario es valido (existe), alamacena en el localStorage el perfil
        Authorize authorize = new Authorize()                    
        {                        
                Name = Name,
                Password = CryptographyManager.GeneratePasswordHash(this.Password) 
        };
        currentUser = manager.GetUser(authorize);
        await manager.DisposeAsync();
        if (currentUser != null)
        {            
            await jsRuntime.InvokeVoidAsync("localStorage.setItem", "Name", authorize.Name);
            await jsRuntime.InvokeVoidAsync("localStorage.setItem", "Password", authorize.Password);
            MultiAvatarUserName = currentUser.Nombre;
            await TravelTo("blue");
        }       
        
        StateHasChanged();
    }

}   